#! /bin/sh

debug=

PATH=$PATH:/S.u.S.E./bin:S.u.S.E./usr/bin
cd /

[ "$debug" ] && echo $LINENO && /bin/bash

if [ ! -d /S.u.S.E./etc ] ; then
  # mount Live CD
  mount -n /S.u.S.E.
fi

[ -d /.livecd/locale ] && export TEXTDOMAINDIR=/.livecd/locale
export TEXTDOMAIN=livecd
if [ -f /etc/sysconfig/language ] ; then
  . /etc/sysconfig/language
fi

LANG=$RC_LANG gettext -n -s "Saving LiveEval CD changes"

if [ -f /etc/install.inf ]; then
  eval `grep ': ' /etc/install.inf | sed -e 's/:  */="/' -e 's/$/"/' -e 's/^/export /'`
fi

if [ -f /etc/SuSElive ] ; then
  . /etc/SuSElive
else
  exit 1
fi

[ "$debug" ] && echo $LINENO && /bin/bash

if [ "$part" -a "$suseimg" ]; then
  i=
  [ "$dosdrive" ] && i="$dosdrive, "
  echo
  printf "`LANG=$RC_LANG gettext 'Writing info to %s on %s (%s, %s MB)'`" "$suseimg" "$part" "$i$fstype" "$partsize"
  echo

  mount -n $part /mnt || error=21

  if [ "$error" = "" -a "$suseimg" ] ; then
    if [ -f /etc/.SuSEfiles ] ; then
      mount -n -oremount,rw /
      rm -f /etc/.SuSErmlist
      for i in `cat /etc/.SuSEfiles` ; do
        if [ ! -e "$i" -a ! -L "$i" ] ; then
          echo "$i" >>/etc/.SuSErmlist
        fi
      done
      mount -n -oremount,ro /
    fi
    tar --exclude /dev/console -zclf /mnt/$suseimg / 2>/dev/null || error=1
  fi

  if [ "$error" ] ; then
    printf "`LANG=$RC_LANG gettext 'An error occurred while writing %s.'`" "$suseimg"
    echo
    LANG=$RC_LANG gettext -s "Sorry, your LiveEval CD changes might be lost. :-("
  fi

  umount -n /mnt
fi

[ "$debug" ] && echo $LINENO && /bin/bash

umount -n /S.u.S.E.
# umount Live CD

[ "$debug" ] && echo $LINENO && /bin/bash

exit 0
