#! /bin/sh

yast="$1"
shift

exec 2>&1
stty sane

echo -en \\033c

# linuxrc passes the root directory of the freshly mounted instsys in
# the environment variable INSTSYS.
#

# this script will symlink from the initrd to all files and
# directories missing.

# a few files should be restored when installation has completed if we
# return to linuxrc.
FILES_TO_RESTORE="/etc/ld.so.cache"
for file in $FILES_TO_RESTORE
do
    test -e $file && mv $file $file.initrd
done


echo "integrating the installation system into the ramdisk..."
$INSTSYS/usr/bin/conservative_lndir "$INSTSYS" "/"

echo "integrating the shared objects of the installation system..."
ldconfig

if test -x /sbin/syslogd
then
    checkproc /sbin/syslogd || {
	echo "starting syslog (messages are logged to /dev/tty4)..."
	/sbin/syslogd
    }
fi

if test -x /sbin/klogd
then
    checkproc /sbin/klogd || {
	echo "starting klogd ..."
	/sbin/klogd -f /dev/null -c 1
}
fi

arch=$(uname -m)

case "$arch" in
  i?86)
    # remove modules to free memory
    if [ "$REMOVE_MODULES" = 1 ] ; then
      rm -f /modules/*
    fi
  ;;
esac

# create a new modules.dep
#
# modules from initrd (in /modules) are preferred over those from CD (below
# /lib/modules)
#
rm -f /etc/modules.conf
cp "$INSTSYS/etc/modules.conf" /etc
cat >>/etc/modules.conf <<EOF
path=/modules
path=/lib/modules/`uname -r`
depfile=/etc/modules.dep
generic_stringfile=/etc/modules.generic_string
pcimapfile=/etc/modules.pcimap
isapnpmapfile=/etc/modules.isapnpmap
usbmapfile=/etc/modules.usbmap
parportmapfile=/etc/modules.parportmap
ieee1394mapfile=/etc/modules.ieee1394map
pnpbiosmapfile=/etc/modules.pnpbiosmap
EOF

echo "integrating kernel modules of the installation system..."
depmod -a 2>/dev/null

# eventually start sshd
case "$arch" in
    s390|s390x)
	test -r /etc/netsetup.inf && cat /etc/netsetup.inf >> /etc/install.inf
	;;
    *)
	if [ -x /sbin/inst_setup_ssh ] && \
          grep -vq ' nossh' /proc/cmdline && \
          grep -qE 'InstMode:[[:space:]]*(nfs|http|ftp|tftp|smb)' /etc/install.inf ; then
	. /sbin/inst_setup_ssh
	fi
        ;;
esac


# yast1 doesn't like it
rm -f /etc/fstab

# start shell, useful on iSeries or via serial console
grep -qwi start_shell /proc/cmdline && { echo ; echo "ATTENTION" ; echo "Starting shell... (use 'exit' to proceed)" ; bash --init-file /root/.bash_login ; }

# now, run yast
echo "starting yast..."
ec=
if [ "$yast" = yast1 ] ; then
  /sbin/yast "$@" ; ec=$?
elif [ "$yast" = yast2 ] ; then
  /usr/lib/YaST2/bin/YaST2.start "$@" ; ec=$?
elif [ "$yast" ] ; then
  "$yast" "$@" ; ec=$?
fi

# start shell, useful on iSeries or via serial console
grep -qwi start_shell /proc/cmdline && { echo ; echo "ATTENTION" ; echo "Starting shell... (use 'exit' to proceed)" ; bash --init-file /root/.bash_login ; }

case "$arch" in
    s390|s390x)
	test -r /etc/netsetup.inf && cat /etc/netsetup.inf >> /etc/install.inf
	[ $ec -ne 0 ] && echo "An Error happened during installation"
	ec=0
	;;
    *)
	# stop vnc
	killall Xvnc 2>/dev/null >/dev/null
	# stop sshd
	killall sshd 2>/dev/null >/dev/null
esac

umount devpts 2>/dev/null

for file in $FILES_TO_RESTORE
do
    test -e $file.initrd && mv $file.initrd $file
done


exit $ec
