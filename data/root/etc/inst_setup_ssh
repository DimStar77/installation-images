# will be sourced by /sbin/inst_setup

# vim: syntax=sh

echo 'sshd found, prepare remote login'
unset SSH_FAILED
test -L /etc/ssh && { rm -f /etc/ssh ; mkdir -p /etc/ssh ; }
test -L /root && rm -f /root
mkdir -p /root
cp -a $INSTSYS/root/.bash_login /root
cp -a $INSTSYS/root/.bash_history /root
cp -a $INSTSYS/root/.vimrc /root
cp -a $INSTSYS/etc/ssh/{moduli,primes,ssh*config*} /etc
# not needed in initrd
grep -vi UsePrivilegeSeparation < $INSTSYS/etc/ssh/sshd_config > /etc/ssh/sshd_config
echo UsePrivilegeSeparation no >> /etc/ssh/sshd_config
#
test -z "$nameserver" || echo "nameserver $nameserver" > /etc/resolv.conf
test -z "$domain" || echo "search $domain" >> /etc/resolv.conf
mkdir -p /dev/pts
mkdir -p /dev/shm
grep -q devpts /proc/mounts || \
mount -n -t devpts -o mode=0620,gid=5 devpts /dev/pts
#
if [ "$(hostname)" = "(none)" ] ; then
THIS_HOST_IP=$(awk ' /^IP:/ { print $2 }' < /etc/install.inf)
test -z "$THIS_HOST_IP" || hostname $THIS_HOST_IP
test -z "$domain" || domainname $domain
fi
#
if grep -qi nosshkey < /proc/cmdline ; then
	# for inst-sys testing
	cp -av $INSTSYS/etc/ssh/*key* /etc/ssh/
else
	#
	echo "generating SSH keys  ...  "
	#
	if ! test -f /etc/ssh/ssh_host_key ; then
	    echo Generating /etc/ssh/ssh_host_key.
	    ssh-keygen -t rsa1 -b 1024 -f /etc/ssh/ssh_host_key -N ''
	fi
	if ! test -f /etc/ssh/ssh_host_dsa_key ; then
	    echo Generating /etc/ssh/ssh_host_dsa_key.

	    ssh-keygen -t dsa -b 1024 -f /etc/ssh/ssh_host_dsa_key -N ''
	fi
	if ! test -f /etc/ssh/ssh_host_rsa_key ; then
	    echo Generating /etc/ssh/ssh_host_rsa_key.

	    ssh-keygen -t rsa -b 1024 -f /etc/ssh/ssh_host_rsa_key -N ''
	fi
fi
chmod -R og-rxw  /etc/ssh /root /etc/shadow 2>/dev/null
chown -R 0.0  /etc/ssh /root /etc/shadow 2>/dev/null
echo "Starting SSH daemon  ...  "
#
/usr/sbin/sshd || {
export SSH_FAILED=true
echo 'sshd did NOT start!'
}
if [ ! "$SSH_FAILED" ] ; then
	echo
	echo /sbin/ifconfig `grep eth /proc/net/dev | cut -f 1 -d : `
	for i in  `grep eth /proc/net/dev | cut -f 1 -d : ` ; do
	    /sbin/ifconfig $i | grep UP > /dev/null 2>&1 && /sbin/ifconfig $i | head -n 2
	done
	cat <<EOF

      ***  sshd has been started  ***

  Press return to contiunue...
EOF
	read
fi

grep -iq < /proc/cmdline debug && {
export Y2DEBUG=1
export Y2MAXLOGSIZE=50000
export Y2MAXLOGNUM=5
test -d $INSTSYS/root/.yast2 && cp -a $INSTSYS/root/.yast2 /root
}

