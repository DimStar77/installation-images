#!/bin/bash

usage="$0 [IGNORE_FILE [ROOT]... ]

after this call, there are no more ampty subdirectories below root,
except those listed in IGNORE_FILE (which are supposed to be relative
to ROOT (which defaults to .))."

test $# -gt 0 && { IGNORE_FILE="$1"; shift; }

# set CONDOM=echo be on the safe side
: ${CONDOM:=}

test IGNORE_FILE = "-" && IGNORE_FILE=""
{
    ${IGNORE_FILE+sed 's-.*-255 X &/DUMMY-' "$IGNORE_FILE"}
    find "$*"    -type d -printf "%d D %p %h %f\n" 
    find "$*" \! -type d -printf "%d X %p %h %f\n" 
} |
sort -k 1nr -k2 |
# 
awk '
BEGIN {
    depth=1
    type=2
    fullname=3
    dirname=4
    filename=5
}
$type == "D" {
    if ($fullname in NOT_EMPTY) {
	NOT_EMPTY[$dirname];
    } else {
	printf "%s\n", $fullname;
    }
}
$type == "X" {
    NOT_EMPTY[$dirname];
}
' |
xargs --verbose --no-run-if-empty $CONDOM rmdir