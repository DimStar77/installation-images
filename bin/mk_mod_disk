#! /usr/bin/perl -w

# Create a module disk.
#
# Usage:        mk_mod_disk

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;
use AddFiles;
use MakeFATImage;

die "usage: $Script\n" if @ARGV;


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$srcdir = "${ImagePath}";
$image = "${ImagePath}modules";

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

$disk = 1;
$disk = $ENV{modules} + 0 if exists $ENV{modules};

$i1 = $ConfigData{suse_major_release};
$i2 = $ConfigData{suse_minor_release};

$label = "SUSE${i1}${i2}_MODS";

# create an empty image
($blocks, $block_size) = MakeFATImage($image, $label, 1);

die "$Script: failed to create DOS disk image \"$image\"\n" unless defined $blocks;

printf "$Script: image \"%s\", %u blocks a %u bytes (%u total)\n", $image, $blocks, $block_size, $blocks * $block_size;

# umount it first, just in case
SUSystem "umount /mnt 2>/dev/null";

# add the other files
SUSystem "mount -oloop -t vfat $image /mnt" and
  die "$Script: mount failed";

if($disk == 2) {
  SUSystem "cp  $srcdir/net2mod.gz /mnt/net-mod.gz" and
    die "$Script: could not add net2mod.gz";
  SUSystem "cp  $srcdir/other2mo.gz /mnt/other-mod.gz" and
    die "$Script: could not add other2mo.gz";
}
else {
  SUSystem "cp $srcdir/net-mod.gz $srcdir/other-mod.gz $srcdir/scsi-mod.gz /mnt" and
    die "$Script: could not add module images";
}

$i3 = $i2*10;
SUSystem "touch -d $i1:$i3 /mnt/*";

print "contents of $image:\n";
system "ls -l /mnt";

SUSystem "umount /mnt" and
  die "$Script: umount failed";

Print2File $MToolsCfg, "drive r: file=\"$image\"\n" or die "$Script: oops!";
@f = `mdir r:`;
unlink $MToolsCfg;

for (@f) {
  if(/^\s*([ 0-9]+?)\s+bytes\s+free\s*$/) {
    $free = $1;
    $free =~ s/\s+//g;
    last;
  }
}

die "$Script: oops, no space on modules disk???" unless defined $free;

print "$Script: prepared modules disk \"$image\"; $free bytes free\n";

