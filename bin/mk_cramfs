#! /usr/bin/perl


# usage: mk_cramfs dir image
#
# create a cramfs image suitable for linuxrc (image length coded
# into file name that is stored in cramfs header).

sub pcramfs;

($dir, $image) = @ARGV;

die "usage: mk_cramfs dir image\n" unless -d($dir) && $image;

system "mkcramfs $dir $image" and die "mkcramfs failed";
$size = -s $image;
die "no image?" if $size == 0;
$name = $image;
$name =~ s#^.*/##;
die "strange image name" if $name eq "";
$name .= " " . ($size >> 10);
pcramfs $name, $image;


# patch new name into cramfs
# (we could run mkcramfs with '-n' again, but it's faster this way)
sub pcramfs
{
  $file = shift;
  $fs = shift;

  if(length($file) > 15 || length($file) < 1) {
    die "invalid file name \"$file\" (too long?)\n"
  }

  $file .= "\x00" x (16 - length($file));

  open F, "+<$fs";

  sysread F, $buf, 64;

  seek F, 0, SEEK_SET;

  die "oops, is not cramfs\n" unless length($buf) == 64 && substr($buf, 16, 16) eq "Compressed ROMFS" ;

  substr($buf, 48, 16) = $file;

  syswrite F, $buf;

  close F;
}
