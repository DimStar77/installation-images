#! /bin/sh

# check in bootdisk to /work/src/done/STABLE
# call from the y2image directory

# filelist:		disk_i386.file_list
# kernel:		k_i386

ver=`cat VERSION`
bootdisk=/tmp/bootdisk-$ver

if [ "$ver" = "" ] ; then
  echo "no version info?"
  exit 1
fi

echo "going to check in bootdisk version $ver..."

make clean
rm -rf $bootdisk
mkdir $bootdisk
tar -cf - * | tar -C $bootdisk -xf -
cd $bootdisk
find . -depth -name CVS -exec rm -r {} \;
rm -rf bin/ci_* MAINTAINER cache
perl -pi -e 's/k_deflt/k_i386/g' etc/config
cd /tmp

if [ "$1" = test ] ; then
  echo "bootdisk directory tree: $bootdisk"
  exit
fi

tar -Icf $bootdisk.tar.bz2 bootdisk-$ver

if mkdir /work/src/done/STABLE/bootdisk ; then
  cd /work/src/done/STABLE/bootdisk
  cp $bootdisk.tar.bz2 /work/SRC/arch/i386/bootdisk/bootdisk.{changes,spec} .
  perl -pi -e 's/^(Version:\s+)\S+/${1}'$ver'/' /work/src/done/STABLE/bootdisk/bootdisk.spec
  perl -pi -e 's/^(Source.+?-)\S+?(\.tar\.bz2)/${1}'$ver'${2}/' /work/src/done/STABLE/bootdisk/bootdisk.spec
  . /work/src/bin/.profile
  vc bootdisk
  rm /work/src/done/STABLE/bootdisk/*~
  echo "ok"
else
  echo oops
  exit 1
fi
