#! /usr/bin/perl

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;

die "usage: $Script\n" if @ARGV;

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$dst = "${DataPath}base/gen/splash";

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

$debug = exists($ENV{'debug'}) ?  $ENV{'debug'} : "";
$full_splash = $ENV{'full_splash'} || $ENV{'full_splash'} eq "" ? "" : " -n";

if($ENV{themes}) {
  @themes{split ' ', $ENV{themes}} = ();
}

for (keys %{$ConfigData{ini}}) {
  next unless /^Theme (.+)$/;
  next unless $ConfigData{ini}{$_}{splash};

  $st{$ConfigData{ini}{$_}{splash}} = 1 if !%themes || exists $themes{$1};
}

mkdir "${DataPath}base/gen", 0755;

open W, ">$dst";

print W "if arch eq 'ia32' || arch eq 'x86_64'\n";
print W "  gfxboot:\n    /\n    r /usr/sbin/getx11font\nendif\n";
for (sort keys %st) {
  print W
    "  d /$_\n" .
    "  d /$_/floppy\n" .
    "  d /$_/gz\n" .
    "if arch eq 'ia32' || arch eq 'x86_64'\n" .
    "    E make -C /usr/share/gfxboot/themes/$_\n" .
    "    E cp /usr/share/gfxboot/themes/$_/install/bootlogo /$_\n" .
    "endif\n";
}

for (sort keys %st) {
  print W
    "\nbootsplash-theme-$_:\n  /\n";

  undef %fl_spl;
  @fl_spl{split /\s|,/, $ConfigData{ini}{Splash}{floppy}} = ();

  for $res (split /\s|,/, $ConfigData{ini}{Splash}{cdrom}) {
    $res2 = sprintf "%04u%04u", split(/x/, $res);
#    print W "  E splash -s${full_splash} -f /etc/bootsplash/themes/$_/config/bootsplash-${res}.cfg >/$_/${res2}.spl\n";
#    print W "  E splash -s${full_splash} -c -f /etc/bootsplash/themes/$_/config/bootsplash-${res}.cfg | gzip -9c >/$_/gz/${res2}.spl\n";
    print W "  E /mk_splash $_ $res $res2\n";
    print W "  l /$_/gz/${res2}.spl /$_/floppy\n" if exists $fl_spl{$res};
  }
  print W "\n";
}

close W;

