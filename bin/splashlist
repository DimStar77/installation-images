#! /usr/bin/perl

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;

die "usage: $Script\n" if @ARGV;

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$dst = "${DataPath}base/gen/splash";

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

$debug = exists($ENV{'debug'}) ?  $ENV{'debug'} : "";
$full_splash = $ENV{'full_splash'} || $ENV{'full_splash'} eq "" ? "" : " -n";

if($ENV{themes}) {
  @themes{split ' ', $ENV{themes}} = ();
}

for (keys %{$ConfigData{ini}}) {
  next unless /^Theme (.+)$/;
  next unless $ConfigData{ini}{$_}{bsplash};
  $st{$1}{bsplash} = $ConfigData{ini}{$_}{bsplash} if !%themes || exists $themes{$1};
}

for (keys %{$ConfigData{ini}}) {
  next unless /^Theme (.+)$/;
  next unless $ConfigData{ini}{$_}{ksplash};
  $st{$1}{ksplash} = $ConfigData{ini}{$_}{ksplash} if !%themes || exists $themes{$1};
}

mkdir "${DataPath}base/gen", 0755;

open W, ">$dst";

print W "if arch eq 'ia32' || arch eq 'x86_64'\n";
print W "  gfxboot:\n    /\n    r /usr/sbin/getx11font\nendif\n";
for (sort keys %st) {
  next unless $st{$_}{bsplash};

  print W
    "  d /$_\n" .
    "  d /$_/floppy\n" .
    "  d /$_/gz\n" .
    "if arch eq 'ia32' || arch eq 'x86_64'\n" .
    "    E make -C /usr/share/gfxboot/themes/$st{$_}{bsplash}\n" .
    "    E cp /usr/share/gfxboot/themes/$st{$_}{bsplash}/install/bootlogo /$_\n" .
    "endif\n";
}

for (sort keys %st) {
  next unless $st{$_}{ksplash};

  print W
    "\nbootsplash-theme-$st{$_}{ksplash}:\n  /\n";

  undef %fl_spl;
  @fl_spl{split /\s|,/, $ConfigData{ini}{Splash}{floppy}} = ();

  for $res (split /\s|,/, $ConfigData{ini}{Splash}{cdrom}) {
    $res2 = sprintf "%04u%04u", split(/x/, $res);
    print W "  E /mk_splash $_ $st{$_}{ksplash} $res $res2\n";
    print W "  l /$_/gz/${res2}.spl /$_/floppy\n" if exists $fl_spl{$res};
  }
  print W "\n";
}

close W;

