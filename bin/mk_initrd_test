#! /usr/bin/perl -w

# Create a test environment for linuxrc/initrd
#
# Source files are taken from images/initrd; the environment is created in
# test/initrd.
#
# Usage:        mk_initrd_test

=head1 mk_initrd_test

C<mk_initrd_test> creates a test environment for C<linuxrc>/C<initrd>.

It basically unpacks the initial ram disk found in C<images/initrd> into
C<test/initrd> and mounts C<test/initrd/proc>. An existing old version will
be deleted (and C<test/initrd/proc> and C<test/initrd/mnt> are unmounted)
before.

Then, run C<initrd_test> for the actual test.

=cut


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;

die "usage: $Script\n" if @ARGV;


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$srcimg = "${ImagePath}initrd";
$dstdir = "${BasePath}test/initrd";

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

# uncompress the image
system "gunzip -c $srcimg >$TmpBase" and
  die "$Script: gunzip failed";

# remove existing stuff
if(-d $dstdir) {
  print "$Script: removing old stuff from \"$dstdir\"\n";
  SUSystem "umount $dstdir/proc 2>/dev/null";
  SUSystem "umount $dstdir/mnt 2>/dev/null";
  SUSystem "rmdir $dstdir/proc" and die "$Script: /proc still mounted\n";
  SUSystem "rmdir $dstdir/mnt" and die "$Script: /mnt still mounted\n";
  SUSystem "rm -rf $dstdir" and die "$Script: could not remove \"$dstdir\"";
}

# umount it first, just in case
SUSystem "umount /mnt 2>/dev/null";

# add the files
SUSystem "mount -oloop $TmpBase /mnt" and
  die "$Script: mount failed";

system "mkdir -p $dstdir" and
  die "$Script: mkdir failed";

# copy everything
SUSystem "sh -c 'tar -C /mnt -cf - . | tar -C $dstdir -xpf -'" and
  die "$Script: could not extract all files";

unlink $TmpBase;

# unmount it
SUSystem "umount /mnt" and
  die "$Script: umount failed";

print "$Script: extracted initrd to \"$dstdir\"\n";

