#! /usr/bin/perl -w

# Setup a NFS dir to run YaST2 from.
#
# Usage:        mk_yast2_nfs

=head1 mk_yast2_nfs

C<mk_yast2_nfs> creates a C<suse/images> directory with a C<root> image in
it and and extracted C<yast2> image (as a directory C<yast2>).

The location of the NFS directory is given in the C<YaST2_NFS> entry in
C<etc/config>.

It needs C<images/root> and C<images/yast2>.

=cut


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;

die "usage: $Script\n" if @ARGV;


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$image_boot = "${ImagePath}boot";
$image_yast2 = "${ImagePath}yast2";
$yast2_dir = $ConfigData{"yast2_dir"};
$yast2_img = $ConfigData{"yast2_img"};
$nfs_dir = $ConfigData{"YaST2_NFS"};

die "$Script: no yast2 image" unless -f $image_yast2;

die "$Script: where should the YaST2 go to?" unless $yast2_dir;
die "$Script: where should the YaST2 image go to?" unless $yast2_img;
die "$Script: where should the NFS stuff go to?" unless $nfs_dir;

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

if(-d $nfs_dir) {
  SUSystem "rm -rf $nfs_dir/$yast2_dir $yast2_img" and
    die "$Script: failed to remove old yast2 files";
}

if(!-d("$nfs_dir/suse/images")) {
  SUSystem "mkdir -p $nfs_dir/suse/images" and
    die "$Script: failed to create $nfs_dir/suse/images";
}

SUSystem "cp $image_boot $nfs_dir/suse/images" and
  die "$Script: failed to copy the boot image";

SUSystem "mkdir -p $nfs_dir/$yast2_dir" and
  die "$Script: failed to create $nfs_dir/$yast2_dir";

SUSystem "sh -c 'gzip -c -4 $image_yast2 >$nfs_dir/$yast2_img'" and
  die "$Script: failed to add the the yast2 image";

# umount it first, just in case
SUSystem "umount /mnt 2>/dev/null";

# mount the yast2 image
SUSystem "mount -oloop $image_yast2 /mnt" and
  die "$Script: mount failed";

# copy everything
SUSystem "sh -c '( cd /mnt; tar -cf - * ) | tar -C $nfs_dir/$yast2_dir -xpf -'" and
  die "$Script: failed to extract all files from the yast2 image";

# unmount it
SUSystem "umount /mnt" and
  die "$Script: umount failed";

