#! /usr/bin/perl -w

# Create a root image that can be used on a bootable CD.
#
# Source files and the file list are taken from data/root; the final
# image is stored in images/root.
#
# Usage:        mk_root

=head1 mk_root

C<mk_root> creates a C<root> image (not compressed).
This image is intended to go onto a bootable CD.

The files to go into the root image are taken from
C<data/root/root.file_list>.

The final image is stored as C<images/root>.

=cut


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;
use MakeExt2Image;
use AddFiles;
use Conv2Image;

die "usage: $Script\n" if @ARGV;


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$srcdir = "${DataPath}root";
$tmpdir = "${BasePath}tmp/root";
$tmpinitrd = "${BasePath}tmp/initrd";
$image = "${ImagePath}root";

# leave that much space
$extra_size = 500;              # kbyte
$extra_inodes = 100;

# just make them large enough
$start_size = 150000;             # kbyte
$start_inodes = 5000;

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

# clean up
if(-d($tmpdir)) {
  SUSystem "rm -rf $tmpdir" and die "$Script: failed to remove old $tmpdir";
}

AddFiles $tmpdir, "${srcdir}/root.file_list", $srcdir or
  die "$Script: failed to setup root image";

# strip everything
SUSystem "fix_perms $tmpdir";
SUSystem "strip_dir $tmpdir";

SUSystem "ldconfig -r $tmpdir";
die "$Script: failed to run ldconfig" unless -f "$tmpdir/etc/ld.so.cache";

# if(-d "$tmpinitrd/modules$ConfigData{kernel_ver}") {
if(-d "$tmpdir/lib/modules/$ConfigData{kernel_ver}") {
  SUSystem "mkdir $tmpdir/modules";
  SUSystem "ln $tmpinitrd/modules/*.o $tmpdir/modules";
  SUSystem "depmod -a -F $tmpdir/System.map -b $tmpdir $ConfigData{kernel_ver}";
  die "$Script: failed to run depmod" unless -f "$tmpdir/lib/modules/$ConfigData{kernel_ver}/modules.dep";
  SUSystem "rm -r $tmpdir/modules";
  SUSystem "rm $tmpdir/System.map";
  SUSystem "ln -snf /modules $tmpdir/lib/modules/default/misc";
}

Conv2Image $image, $tmpdir, 'ext2', $start_size, $start_inodes, $extra_size, $extra_inodes;

